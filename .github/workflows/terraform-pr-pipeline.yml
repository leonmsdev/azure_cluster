name: Terraform PR Pipeline
on:
  pull_request:
    branches:
      - main

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    steps:
      # Checkout the code from the pull request
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # Install Terraform and other required tools
      - name: Install Terraform and other tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install -y terraform

      # Check Terraform formatting
      - name: Check Terraform formatting
        run: terraform fmt -check -diff

      # Check Terraform linting
      - name: Check Terraform linting
        run: tflint

      # Terraform plan
      - name: Terraform plan
        run: terraform plan

      # Terraform dry-apply
      - name: Terraform dry-apply
        run: terraform apply -input=false -auto-approve
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
