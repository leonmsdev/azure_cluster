name: Terraform PR Pipeline
on:
  pull_request:
    branches:
      - main

permissions:
      id-token: write
      contents: read

env:
  TERRAFORM_VERSION: "1.4.2"

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    steps:
        #auth to azure project
      - name: 'Az CLI login'
        uses: azure/login@v1
        with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
      - name: 'Run Azure CLI commands'
        run: |
            az account show
            az group list
            pwd 

      # Checkout the code from the pull request
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # Install Terraform and other required tools
      - name: Install Terraform and other tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install -y terraform=$TERRAFORM_VERSION
          terraform init

      # Check Terraform formatting
      - name: Check Terraform formatting
        run: terraform fmt -check -diff

      # Terraform plan
      - name: Terraform plan
        run: terraform plan

      # Terraform dry-apply
      - name: Terraform dry-apply
        run: terraform apply -input=false -auto-approve
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
