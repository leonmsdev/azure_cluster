name: Terraform PR Pipeline
on:
  pull_request:
    branches:
      - main

permissions:
      id-token: write
      contents: read

env:
  TERRAFORM_VERSION: "1.4.2"

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    steps:
      # Checkout the code from the pull request
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      # Install Terraform and login to azure
      - name: Install Terraform and authenticate to azure
        run: |
          sudo apt-get update
          sudo apt-get install azure-cli
          az login --service-principal -u ${{ secrets.AZURE_APP_ID }} -p ${{ secrets.AZURE_SP_PASSWORD }} --tenant ${{ secrets.AZURE_TENANT_ID }}
          sudo apt-get install -y unzip
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install -y terraform=$TERRAFORM_VERSION
          terraform init
          
      # Check Terraform formatting
      - name: Check Terraform formatting
        run: terraform fmt -check -diff

      # Check Terraform vlidation
      - name: Terraform Validate
        run: terraform validate

      # Terraform plan
      - name: Terraform plan
        run: terraform plan

      # Terraform dry-apply
      - name: Terraform dry-apply
        run: terraform apply -input=false -auto-approve
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
